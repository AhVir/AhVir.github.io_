<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private File Upload with Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 480px; margin: 2rem auto; padding: 1rem; }
    input, button { padding: 0.5rem; margin: 0.25rem 0; width: 100%; }
    button { cursor: pointer; }
    #upload-section, #file-list-section, #logout-btn { display: none; margin-top: 1rem; }
    ul { list-style: none; padding-left: 0; }
    li a { text-decoration: none; color: #0077cc; }
    li a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <h2>Login to Upload Files</h2>
  <div id="auth-section">
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
  </div>

  <button id="logout-btn" onclick="logout()">Logout</button>

  <div id="upload-section">
    <h3>Upload a file</h3>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">Upload</button>
  </div>

  <div id="file-list-section">
    <h3>Your Files:</h3>
    <ul id="fileList"></ul>
  </div>

<script>
  // Initialize Supabase
  const supabaseUrl = 'https://hvdzrokpxdchfzkpezaz.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2ZHpyb2tweGRjaGZ6a3BlemF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDY0NzYsImV4cCI6MjA2OTgyMjQ3Nn0.o4MTIBjPzMieZ-wzmdQVVrJ7QRfuSrQA_hhZ7x75Plk';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Check auth state on page load
  supabase.auth.onAuthStateChange((event, session) => {
    if (session?.user) {
      showApp(session.user);
    } else {
      showLogin();
    }
  });

  async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) return alert('Enter email and password');

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert('Login failed: ' + error.message);

    showApp(data.user);
  }

  async function signup() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) return alert('Enter email and password');

    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) return alert('Signup failed: ' + error.message);

    alert('Sign up successful! Please check your email for confirmation.');
  }

  async function logout() {
    await supabase.auth.signOut();
    showLogin();
  }

  function showLogin() {
    document.getElementById('auth-section').style.display = 'block';
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('file-list-section').style.display = 'none';
    document.getElementById('logout-btn').style.display = 'none';
  }

  function showApp(user) {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('upload-section').style.display = 'block';
    document.getElementById('file-list-section').style.display = 'block';
    document.getElementById('logout-btn').style.display = 'inline-block';
    listFiles(user.id);
  }

  async function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) return alert('Select a file first');

    const user = supabase.auth.getUser();
    const { data: { user: currentUser } } = await user;
    if (!currentUser) return alert('User not logged in');

    const filePath = `${currentUser.id}/${file.name}`;

    // Upload file to bucket 'uploads'
    const { data, error } = await supabase.storage
      .from('uploads')
      .upload(filePath, file, { upsert: true });

    if (error) {
      alert('Upload error: ' + error.message);
      return;
    }

    // Insert metadata with owner in storage.objects table
    const { error: metaError } = await supabase
      .from('objects')
      .insert({
        bucket_id: 'uploads',
        name: filePath,
        owner: currentUser.id,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      });

    if (metaError) {
      alert('Error saving file metadata: ' + metaError.message);
      return;
    }

    alert('File uploaded successfully!');
    fileInput.value = '';
    listFiles(currentUser.id);
  }

  async function listFiles(userId) {
    // Fetch user files from storage.objects table filtered by owner
    const { data, error } = await supabase
      .from('objects')
      .select('name')
      .eq('owner', userId);

    if (error) {
      document.getElementById('fileList').innerText = 'Error loading files.';
      return;
    }

    const listEl = document.getElementById('fileList');
    listEl.innerHTML = '';

    for (const fileObj of data) {
      const { data: urlData, error: urlError } = await supabase.storage
        .from('uploads')
        .createSignedUrl(fileObj.name, 60); // 60 seconds validity

      if (urlError) continue; // skip if error

      const li = document.createElement('li');
      li.innerHTML = `<a href="${urlData.signedUrl}" target="_blank" rel="noopener noreferrer">${fileObj.name.split('/').pop()}</a>`;
      listEl.appendChild(li);
    }
  }
</script>
</body>
</html>
